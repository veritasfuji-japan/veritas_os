# コアレビュー（Planner / Kernel / Fuji / MemoryOS）

日付: 2026-02-13
対象範囲:
- `veritas_os/core/planner.py`
- `veritas_os/core/kernel.py`
- `veritas_os/core/fuji.py`
- `veritas_os/core/memory.py`

## レビュー要約

コア責務は概ね適切に分離されています。
- Planner: 意図判定と計画正規化
- Kernel: オーケストレーションとツール実行
- Fuji: ポリシー／セーフティゲートと TrustLog 連携
- MemoryOS: 永続化および検索レイヤー

即時リファクタが必要な、責務越境レベルのアーキテクチャ違反は確認されませんでした。

## 良い点

1. **防御的フォールバック設計が一貫している**
   - 任意依存が利用不可でも、複数モジュールが段階的に劣化して継続動作します。

2. **MemoryOS のセキュリティ姿勢が改善されている**
   - Pickle 移行が明確に非推奨化され、環境変数で制御されています。
   - 制限付き unpickle と構造検証が実装されています。

3. **Fuji の判定不変条件が明文化されている**
   - 内部 `status` と外部 `decision_status` の対応が明確です。

## リスク / 指摘事項

### 1) プロンプトインジェクション回避余地が残る（中、セキュリティ）
- `fuji.py` の検出は正規表現ベースのため、空白難読化・同形異体文字・多段分割で回避される可能性があります。
- 現状の実装はヒューリスティックとして有用ですが、網羅的防御ではありません。

**推奨**
- 正規化の強化（Unicode 正規化、ゼロ幅文字除去）を追加する。
- 難読化インジェクションを対象にした対抗テストを追加する。

### 2) `run_env_tool` の例外吸収により可観測性が低下しうる（低）
- `kernel.py` は広範な例外を捕捉し、汎用ペイロードで返します。
- 可用性維持には有効ですが、障害が連続した際の原因追跡性が弱くなります。

**推奨**
- 現行 API 形状は維持しつつ、構造化エラーコードと抑制付きログを追加する。

### 3) Simple-QA ヒューリスティックの多言語端境ケースが弱い可能性（低）
- `planner.py` は短文長＋疑問符を主軸に判定しています。
- AGI 系ブロック語はあるものの、短い運用系クエリで意図ドリフトの余地があります。

**推奨**
- 日英混在の短文クエリに対する小規模 precision/recall ベンチを追加する。

### 4) legacy pickle 移行には残余リスクがある（中、セキュリティ）
- 制限付きデシリアライズでも、本質的リスクは残ります。
- 現在のゲーティングと検証は有効ですが、暫定措置として扱うべきです。

**推奨**
- 廃止タイムラインと移行テレメトリ（残存 pickle 数）を定義する。

## 優先アクション

1. **セキュリティ最優先**: Fuji に難読化プロンプトインジェクションの対抗テストを追加。
2. **信頼性**: Kernel の env-tool 失敗時可観測性を、API 互換を保ったまま改善。
3. **品質**: Planner の Simple-QA 判定に多言語回帰テストを追加。
4. **廃止完了**: MemoryOS の pickle 移行を段階的に撤去する計画を実施。

## 最終評価

- コアは本番運用志向で、構造的に安定しています。
- 最も優先すべき課題は、**難読化プロンプトインジェクションへのセキュリティ堅牢化**と、
  **pickle 移行の完全廃止に向けた明確なロードマップ**です。
