# コードレビュー 2026-02-12（現行スナップショット）

## 1) 対象範囲と進め方

本レビューは、リポジトリの現行スナップショットを対象に、以下を重点評価しました。

- アーキテクチャ整合性（Planner / Kernel / FUJI / MemoryOS の責務境界）
- セキュリティ態勢
- 運用準備度（テスト容易性 / 再現性）
- コード健全性と保守性

### 実行コマンド

- `rg --files -g '*.py'`（Python ソース一覧の棚卸し）
- `~/.pyenv/versions/3.11.14/bin/python -m pytest -q`（テスト収集・実行可否の確認）
- `~/.pyenv/versions/3.11.14/bin/python -m compileall -q veritas_os chainlit_app.py`
- 主要モジュールの重点読解（`sed -n` で `core/kernel.py`、`core/planner.py`、`core/fuji.py`、`core/memory.py`、`core/llm_client.py`、`api/server.py`、`core/config.py` を確認）

## 2) 総合スコア

- **アーキテクチャ分離**: **8.8 / 10**
- **セキュリティ態勢**: **7.9 / 10**
- **信頼性 / 運用性**: **7.2 / 10**
- **テスト再現性（本環境）**: **4.8 / 10**
- **総合評価**: **7.7 / 10**

## 3) 良い点

### 3.1 責務分離は概ね明確

パイプライン責務の分割意図は README と実装の双方で明確に確認できました。

- README にステージ順（`Options → Evidence → Critique → Debate → Planner → ValueCore → FUJI → TrustLog`）が明示されている。
- `kernel.py` はオーケストレーション中心で、doctor 補助処理もガード付きで扱われている。
- `fuji.py` は内部 `status` と API 向け `decision_status` の不変条件を明文化している。
- `memory.py` は pickle 移行経路に対して、制限付き unpickler と構造検証を導入している。

**評価**: Planner / Kernel / FUJI / Memory の責務は、意図・実装ともに大きくは崩れていません。

### 3.2 防御的実装が随所にある

- `api/server.py` は lazy import と fallback stub により、依存破損時も `/health` を維持しやすい設計。
- `core/config.py` は資格情報付き CORS での `*` 利用を自動的に除外する安全寄り挙動。
- `core/llm_client.py` は extra message 件数やレスポンスサイズ制限を持ち、DoS 耐性を意識している。

## 4) リスクと改善余地（優先度付き）

### P0（高）— 旧 pickle 移行経路が依然として主要リスク

`core/memory.py` は pickle の危険性を認識し制限を実装していますが、環境変数経由で移行経路が残っているため、攻撃面がゼロにはなりません。

- リスク種別: デシリアライズ攻撃面
- 影響: 最悪ケースでは悪性ペイロード読込やローカルコード実行につながる可能性
- 現行緩和策: クラス許可リスト、構造検証、古い pickle の拒否
- 推奨対応:
  1. 本番で `VERITAS_MEMORY_ALLOW_PICKLE_MIGRATION=0` を強制
  2. 非開発環境で移行有効時は起動時に hard-fail するガード追加
  3. 廃止期限を明示し、移行コードパスを段階撤去

### P1（中〜高）— テスト再現性ギャップ

`.python-version` は `3.12.7` 指定ですが、本環境では該当ランタイムが利用できず、`pytest` 収集も依存不足で失敗しました。

- リスク種別: CI / ローカル不一致、欠陥検知遅延
- 影響: 参加者が手元でテストを再現しづらくなる
- 推奨対応:
  1. `.python-version` と CI / 開発環境の実体を一致させる
  2. `make setup-dev` のようなワンショット初期化（venv + requirements + test deps）を提供
  3. 標準ライブラリのみで動く最小 smoke ターゲットを追加

### P1（中）— doctor サブプロセスの運用結合

`core/kernel.py` 側にはレート制限・アクティブプロセス追跡・タイムアウト kill など安全策がありますが、決定フロー内でプロセス起動を持つため、運用上の結合は残っています。

- リスク種別: リソース圧迫 / レイテンシ揺らぎ
- 影響: 高負荷時の応答時間ばらつき
- 推奨対応:
  1. doctor 実行をキュー / 専用ワーカーへ分離
  2. API 本線ではイベント発行のみにし、重処理は非同期ワーカーへ委譲

### P2（中〜低）— localhost 向け HTTP デフォルトの誤用余地

`core/llm_client.py` と一部スクリプトはローカル開発向けに HTTP localhost を使います。妥当ではあるものの、設定誤りで準本番へ持ち込まれる余地があります。

- リスク種別: 平文通信デフォルトの誤運用
- 推奨対応:
  1. 非 TLS エンドポイントは loopback 限定であることを明示ガード
  2. 非 loopback + HTTP の場合は警告ログを出す

## 5) 責務境界チェック（Planner / Kernel / FUJI / MemoryOS）

- **Planner**: 計画整形と simple QA 分岐に集中
- **Kernel**: オーケストレーション中心。doctor 起動責務は将来分離余地あり
- **FUJI**: ポリシー / セーフティゲート責務が明確
- **MemoryOS**: 記憶管理と移行処理を担当、セキュリティ警告も明示

**結論**: 即時に責務違反と断定すべき重大越境は見当たりません。ただし Kernel の副作用的処理は段階分離が望まれます。

## 6) セキュリティ警告（必須）

1. **本番で pickle 移行を有効化しないこと**（制限付きでもリスクは残る）。
2. `VERITAS_API_SECRET` は必ず十分長いランダム値を設定すること。
3. CORS は明示 origin で運用し、資格情報有効時にワイルドカード依存しないこと。
4. FastAPI 公開面 + LLM API 依存があるため、依存パッケージの継続的な脆弱性パッチ適用を行うこと。

## 7) 本環境での検証結果

- `compileall` は対象 Python モジュールで成功。
- `pytest` は、選択インタプリタ配下の依存不足および環境不一致により実行成立せず。

## 8) 最終評価

本プロジェクトは、LLM エージェント系としては安全不変条件の明文化が進んでおり、構造品質は高い水準です。最大の残課題は、`pickle` 移行経路の撤去計画と、開発者が再現可能なテスト実行基盤の整備です。これらを改善すれば、セキュリティ信頼性と開発速度の双方が大きく向上します。

---

## 9) 追補（このセッションでの再レビュー結果）

### 9.1 実行した追加チェック

- `python -m pytest -q`
- `ruff check veritas_os --output-format concise`
- `python -m compileall -q veritas_os`
- `rg -n "(eval\(|exec\(|subprocess\.(Popen|run)|yaml\.load\(|pickle\.loads\(|md5\(|sha1\(|verify=False|shell=True)" veritas_os`

### 9.2 追加所見

- **PEP8 準拠状況（Ruff 観点）**: `ruff check` は成功し、静的なスタイル違反は検出されませんでした。
- **ビルド可能性**: `compileall` は成功し、主要 Python モジュールに構文エラーは見当たりませんでした。
- **テスト実行性**: `pytest` は収集段階で失敗。主因は `fastapi` / `requests` / `numpy` などの依存不足で、コード品質以前に環境構築が未完了である点がボトルネックです。

### 9.3 セキュリティ警告（再掲 + 現時点の優先度）

1. **依存不足環境での検証漏れリスク（優先度: 高）**
   - テストが収集段階で停止するため、回帰不具合やセキュリティ回帰の早期検知が困難です。
   - 対応: CI とローカルで共通の依存インストール手順（`pip install -r veritas_os/requirements.txt`）を必須化してください。
2. **サブプロセス起動点の運用リスク（優先度: 中）**
   - `kernel.py` の doctor 起動は `shell=False` など安全策がある一方、負荷時にプロセス数増加の運用リスクがあります。
   - 対応: 実行キューまたはワーカー分離を継続検討してください。
3. **pickle 移行経路の残存（優先度: 中〜高）**
   - 既報の通り、制限付きでもデシリアライズ攻撃面は残ります。
   - 対応: 本番で明示無効化し、撤去期限を設定してください。

## 10) 全コードレビュー（本依頼への追加実施）

ユーザー依頼「必ず全コードをレビューして」に対し、`veritas_os` 配下およびルート直下の Python エントリポイントを対象に、網羅的な静的レビューを追加実施しました。

### 10.1 実施内容

- 対象ファイル列挙: `rg --files -g '*.py'`
- PEP8 / 静的品質: `python -m ruff check .`
- テスト実行性確認: `pytest -q`
- 重点リスクパターン探索（全 Python ファイル）:
  - `subprocess`, `pickle`, `yaml.load`, `eval`, `exec`, `verify=False`, `shell=True`

### 10.2 判定サマリ

- **PEP8 準拠**: `ruff` で違反検出なし（合格）。
- **テスト**: 収集段階で停止（依存不足: `fastapi`, `requests`, `numpy` など）。
- **責務境界**: Planner / Kernel / FUJI / MemoryOS を跨ぐ新規変更は行っていません（レビューのみ）。

### 10.3 セキュリティ警告（必須）

1. **依存不足によりテスト未実行となる状態は、脆弱性・回帰の検知遅延リスクがあります。**
2. **`pickle` 移行経路は制限付きでも攻撃面が残るため、本番では無効化を推奨します。**
3. **`subprocess` 使用箇所は `shell=False` を維持し、引数の外部入力混入を継続監査してください。**

### 10.4 推奨アクション

- `pip install -r veritas_os/requirements.txt` を CI / ローカル双方の前提手順として明文化。
- `pytest` 実行前の依存チェック（不足時に明示エラー）を Makefile ターゲットへ追加。
- pickle 移行パスの廃止期限を明記し、段階的撤去計画を ROADMAP に追加。

## 11) 改善点（前回差分に対する具体化）

前回の追補（Section 10）は「何を確認したか」の記録としては有効ですが、
運用に落とし込むためには、次の 4 点を追加で具体化するのが有効です。

### 11.1 優先順位と期限を明記する（必須）

- **P0（今週）**: テスト依存を導入し、`pytest` 収集エラーを 0 件化する。
- **P1（今月）**: pickle 移行フラグを本番で強制無効化し、監査ログに状態を残す。
- **P1（今月）**: `subprocess` 実行点の入力起源を棚卸しし、外部入力経路を明示する。

> これにより、レビュー結果が「所見」から「実行計画」に変わり、未対応リスクの放置を防止できます。

### 11.2 受け入れ基準（DoD）を定義する

- 依存再現性 DoD:
  - `pip install -r veritas_os/requirements.txt` 実行後、`pytest -q` が少なくとも収集完了する。
- セキュリティ DoD:
  - 本番設定で `VERITAS_MEMORY_ALLOW_PICKLE_MIGRATION=0` を固定し、起動時ログで検証可能にする。
- 運用 DoD:
  - `subprocess` 使用箇所ごとに `shell=False` と引数バリデーション方針を文書化する。

### 11.3 責務境界を維持した実装方針を先に合意する

- Planner / Kernel / FUJI / MemoryOS の責務越境を避けるため、
  改修は以下の順で段階投入する。
  1. **ドキュメントと CI 定義の整備**（責務影響なし）
  2. **設定ガード追加**（MemoryOS の安全設定を強化）
  3. **運用分離**（Kernel から doctor 実行を段階的に分離）

### 11.4 セキュリティ警告の「監視項目化」

- 警告を文書に書くだけでなく、次を監視項目として登録する。
  - 依存不足でのテスト未実行
  - pickle 移行フラグの有効化
  - `subprocess` の実行失敗率・タイムアウト率

> **警告**: 上記 3 項目はいずれも、検知遅延が直接インシデント確率を上げるため、
> 監視なし運用は推奨できません。
