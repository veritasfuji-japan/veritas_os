- name: Run tests (with coverage)
  id: pytest
  continue-on-error: true
  run: |
    mkdir -p test-reports coverage-html
    pytest -q veritas_os/tests \
      --cov=veritas_os \
      --cov-report=term-missing \
      --cov-report=xml:coverage.xml \
      --cov-report=html:coverage-html \
      --junitxml=test-reports/pytest.xml

- name: Upload test report (junit)
  if: always()
  uses: actions/upload-artifact@v4
  with:
    name: pytest-${{ matrix.python-version }}
    path: test-reports/pytest.xml
    if-no-files-found: error

- name: Upload coverage (xml + html)
  if: always()
  uses: actions/upload-artifact@v4
  with:
    name: coverage-${{ matrix.python-version }}
    path: |
      coverage.xml
      coverage-html
    if-no-files-found: warn

- name: Fail job if tests failed
  if: steps.pytest.outcome == 'failure'
  run: exit 1
